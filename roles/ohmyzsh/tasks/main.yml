---
# Ensure zsh is available before proceeding
- name: Ensure zsh is installed on macOS
  ansible.builtin.command: brew install zsh
  register: brew_install_zsh
  changed_when: "'Installing' in (brew_install_zsh.stdout | default('')) or brew_install_zsh.rc == 0"
  failed_when: false
  when: ansible_facts['system'] == 'Darwin'

- name: Ensure zsh is installed on Linux (Debian/Ubuntu)
  become: true
  ansible.builtin.apt:
    name: zsh
    state: present
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['os_family'] == 'Debian'

- name: Ensure zsh is installed on Linux (Fedora/RHEL)
  become: true
  ansible.builtin.dnf:
    name: zsh
    state: present
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['os_family'] == 'RedHat'

# tasks file for installOhMyZSH

- name: Check if oh-my-zsh is already installed
  stat:
    dest: "{{ ansible_facts['env']['HOME'] }}/.vimrc"
  register: ohmyzsh_dir

- name: Install oh-my-zsh if not present
  shell: >-
    {% if ansible_facts['system'] == 'Darwin' %}
    curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | RUNZSH=no sh
    {% else %}
    RUNZSH=no CHSH=no KEEP_ZSHRC=yes sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    {% endif %}
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.oh-my-zsh"
  when: not ohmyzsh_dir.stat.exists

- name: Deploy .zshrc from template (with aliases)
  ansible.builtin.template:
    src: zshrc.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
    mode: "0644"
    backup: yes
    owner: "{{ ansible_facts['env']['USER'] | default(ansible_facts['user_id']) }}"

########################
# Vim (.vimrc) profile #
########################

- name: Ensure ~/.vim/tmp exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.vim/tmp"
    state: directory
    mode: "0755"

- name: Deploy .vimrc from template
  ansible.builtin.template:
    src: vimrc.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.vimrc"
    mode: "0644"
    backup: yes
    owner: "{{ ansible_facts['env']['USER'] | default(ansible_facts['user_id']) }}"

#############################
# Optional: colorls install #
#############################

- name: Detect Homebrew prefix for ohmyzsh role
  ansible.builtin.stat:
    path: /opt/homebrew/bin/brew
  register: ohmyzsh_opt_brew

- name: Set Homebrew prefix (ohmyzsh)
  ansible.builtin.set_fact:
    ohmyzsh_brew_prefix: "{{ '/opt/homebrew' if (ansible_facts['system'] == 'Darwin' and (ohmyzsh_opt_brew.stat.exists | default(false))) else '/usr/local' }}"

- name: Install ruby via Homebrew for colorls (optional)
  when: (ohmyzsh_install_colorls | default(true)) | bool
  ansible.builtin.command: "{{ ohmyzsh_brew_prefix }}/bin/brew install ruby"
  changed_when: false
  failed_when: false

- name: Install colorls gem (optional)
  when: (ohmyzsh_install_colorls | default(true)) | bool
  ansible.builtin.command: "{{ ohmyzsh_brew_prefix }}/opt/ruby/bin/gem install colorls --no-document"
  changed_when: false
  failed_when: false

- name: Locate colorls executable path
  when: (ohmyzsh_install_colorls | default(true)) | bool
  ansible.builtin.shell: |
    ls -1 {{ ohmyzsh_brew_prefix }}/lib/ruby/gems/*/bin/colorls 2>/dev/null | head -1 || true
  args:
    executable: /bin/bash
  register: colorls_path
  changed_when: false
  failed_when: false

- name: Symlink colorls into Homebrew bin
  when:
    - (ohmyzsh_install_colorls | default(true)) | bool
    - (colorls_path.stdout | default('')) != ''
  ansible.builtin.file:
    src: "{{ colorls_path.stdout }}"
    dest: "{{ ohmyzsh_brew_prefix }}/bin/colorls"
    state: link
    force: true
  become: true

- name: Locate zsh binary
  ansible.builtin.command: which zsh
  register: located_zsh
  changed_when: false
  failed_when: located_zsh.rc != 0

- name: Set zsh as default shell
  become: true
  ansible.builtin.user:
    name: "{{ ansible_facts['user_id'] }}"
    shell: "{{ located_zsh.stdout | default('/bin/zsh') }}"
  when:
    - located_zsh.stdout is defined
    - located_zsh.stdout != ''
    - (ansible_facts['env']['SHELL'] | default('')) != located_zsh.stdout

- name: Ensure Bash shells hand off to zsh
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    create: true
    mode: "0644"
    marker: "# {mark} auto-exec zsh"
    block: |
      if command -v zsh >/dev/null 2>&1; then
        if [ -z "$ZSH_VERSION" ]; then
          export SHELL="$(command -v zsh)"
          exec "$SHELL"
        fi
      fi
  when: located_zsh.stdout is defined and located_zsh.stdout != ''
