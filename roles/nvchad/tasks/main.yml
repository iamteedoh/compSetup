---
# Role: nvchad
# Installs Neovim (via Homebrew), NVChad, and applies user config overrides.

- name: Ensure Neovim is installed (macOS)
  ansible.builtin.command: brew install neovim
  register: nvim_install_brew
  changed_when: "'Installing' in (nvim_install_brew.stdout | default('')) or nvim_install_brew.rc == 0"
  failed_when: false
  when: ansible_facts['system'] == 'Darwin'

- name: Ensure Neovim is installed (Linux - Debian/Ubuntu)
  become: true
  ansible.builtin.apt:
    name: neovim
    state: present
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['os_family'] == 'Debian'

- name: Ensure Neovim is installed (Linux - Fedora/RHEL)
  become: true
  ansible.builtin.dnf:
    name: neovim
    state: present
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['os_family'] == 'RedHat'

- name: Gather $HOME
  ansible.builtin.setup:
    gather_subset:
      - env

- name: Ensure Neovim config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
    state: directory
    mode: "0755"

- name: Check if NVChad is already installed (init.lua)
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/init.lua"
  register: nvim_init

- name: Check if NVChad repo exists (.git)
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/.git"
  register: nvim_git

- name: Remove stale ~/.config/nvim when NVChad init.lua is missing
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
    state: absent
  when: not nvim_init.stat.exists

- name: Clone NVChad (if not present)
  ansible.builtin.git:
    repo: https://github.com/NvChad/starter
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
    version: main
    update: yes
    force: yes
    depth: 1
  when: not nvim_git.stat.exists or not nvim_init.stat.exists

- name: Ensure vim.uv compatibility alias for older Neovim
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/init.lua"
    insertbefore: '^local lazypath'
    marker: "-- {mark} compat"
    block: |
      if vim.uv == nil and vim.loop ~= nil then
        vim.uv = vim.loop
      end

- name: Remove stale lua/custom/ directory (v2 remnant)
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/custom"
    state: absent

- name: Ensure configs directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/configs"
    state: directory
    mode: "0755"

- name: Ensure plugins directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins"
    state: directory
    mode: "0755"

- name: Deploy chadrc.lua
  ansible.builtin.template:
    src: chadrc.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/chadrc.lua"
    mode: "0644"

- name: Deploy plugins/init.lua
  ansible.builtin.template:
    src: plugins.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/plugins/init.lua"
    mode: "0644"

- name: Deploy options.lua
  ansible.builtin.template:
    src: options.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/options.lua"
    mode: "0644"

- name: Deploy autocmds.lua
  ansible.builtin.template:
    src: autocmds.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/autocmds.lua"
    mode: "0644"

- name: Deploy mappings.lua
  ansible.builtin.template:
    src: mappings.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/mappings.lua"
    mode: "0644"

- name: Deploy configs/lsp.lua
  ansible.builtin.template:
    src: lsp.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/configs/lsp.lua"
    mode: "0644"

- name: Deploy configs/lint.lua
  ansible.builtin.template:
    src: lint.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/lua/configs/lint.lua"
    mode: "0644"

- name: Ensure after/plugin directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/after/plugin"
    state: directory
    mode: "0755"

- name: Deploy after/plugin cursorline enforcer
  ansible.builtin.template:
    src: after_cursorline.lua.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim/after/plugin/cursorline.lua"
    mode: "0644"

- name: Ensure NVChad plugins are installed (Lazy sync)
  ansible.builtin.shell: |
    set -euo pipefail
    nvim --headless '+lua require("lazy").sync()' +qa
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ (ansible_facts['system'] == 'Darwin') | ternary('/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/local/sbin:', '/usr/bin:/usr/local/bin:') }}{{ ansible_facts['env']['PATH'] }}"
  changed_when: false
  failed_when: false

- name: Bootstrap lazy.nvim if missing (one-time no-op open)
  ansible.builtin.shell: |
    set -euo pipefail
    if [ ! -d "{{ ansible_facts['env']['HOME'] }}/.local/share/nvim/lazy/lazy.nvim" ]; then
      nvim --headless +qa || true
    fi
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ (ansible_facts['system'] == 'Darwin') | ternary('/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/local/sbin:', '/usr/bin:/usr/local/bin:') }}{{ ansible_facts['env']['PATH'] }}"
  changed_when: false
  failed_when: false

- name: Ensure Treesitter parsers are up to date
  ansible.builtin.shell: |
    set -euo pipefail
    nvim --headless '+lua require("nvim-treesitter.install").update({ with_sync = true })()' +qa
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ (ansible_facts['system'] == 'Darwin') | ternary('/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/local/sbin:', '/usr/bin:/usr/local/bin:') }}{{ ansible_facts['env']['PATH'] }}"
  changed_when: false
  failed_when: false

- name: 'Headless sanity check: open a Lua buffer to trigger highlighting'
  ansible.builtin.shell: |
    set -euo pipefail
    printf '%s\n' '-- sanity.lua' 'local x = 1' | nvim --headless '+set ft=lua' '+syntax on' '+silent write! /tmp/.nvim_sanity.lua' '+q'
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ (ansible_facts['system'] == 'Darwin') | ternary('/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/local/sbin:', '/usr/bin:/usr/local/bin:') }}{{ ansible_facts['env']['PATH'] }}"
  changed_when: false
  failed_when: false


