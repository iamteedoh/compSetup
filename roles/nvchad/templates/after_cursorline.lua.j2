-- Force cursorline/number highlight after all plugins/themes load
local function apply_cursorline()
  vim.opt_local.number = true
  vim.opt_local.relativenumber = false
  vim.opt_local.cursorline = true
  vim.opt_local.cursorcolumn = false
  vim.opt_local.cursorlineopt = "line"
  -- Dark green, "transparent-like" horizontal line highlight and bright green line number
  vim.api.nvim_set_hl(0, "CursorLine", { bg = "#103E16" })
  vim.api.nvim_set_hl(0, "CursorLineNr", { fg = "#00FF5F", bold = true })
  -- Ensure window uses CursorLine mapping
  vim.wo.winhighlight = (vim.wo.winhighlight or ""):gsub("CursorLine:[^,]+", "CursorLine:CursorLine")
  if not string.find(vim.wo.winhighlight, "CursorLine:") then
    if vim.wo.winhighlight == "" then
      vim.wo.winhighlight = "CursorLine:CursorLine"
    else
      vim.wo.winhighlight = vim.wo.winhighlight .. ",CursorLine:CursorLine"
    end
  end
  -- Ensure window uses CursorLineNr mapping
  vim.wo.winhighlight = (vim.wo.winhighlight or ""):gsub("CursorLineNr:[^,]+", "CursorLineNr:CursorLineNr")
  if not string.find(vim.wo.winhighlight, "CursorLineNr:") then
    if vim.wo.winhighlight == "" then
      vim.wo.winhighlight = "CursorLineNr:CursorLineNr"
    else
      vim.wo.winhighlight = vim.wo.winhighlight .. ",CursorLineNr:CursorLineNr"
    end
  end
end

-- Force-disable any vertical guides/columns set by themes/plugins
vim.opt.colorcolumn = ""
vim.api.nvim_set_hl(0, "ColorColumn", { bg = "NONE" })
vim.api.nvim_set_hl(0, "CursorColumn", { bg = "NONE" })

vim.api.nvim_create_autocmd({"VimEnter","WinEnter","BufWinEnter","ColorScheme"}, {
  callback = function()
    vim.wo.colorcolumn = ""
    -- Re-apply after a short delay to win against late overrides
    vim.defer_fn(apply_cursorline, 30)
  end,
})

-- Initial apply
pcall(apply_cursorline)

-- Enforce 85 char auto-wrap on insert across filetypes after all configs
local function enforce_wrap_85()
  vim.opt_local.wrap = true
  vim.opt_local.textwidth = 85
  local fo = vim.api.nvim_get_option_value('formatoptions', { scope = 'local' })
  fo = fo:gsub('l','')
  if not fo:match('t') then fo = fo .. 't' end
  vim.api.nvim_set_option_value('formatoptions', fo, { scope = 'local' })
end

-- Run once now
pcall(enforce_wrap_85)

-- Re-run on typical events and after NVChad's VeryLazy
vim.api.nvim_create_autocmd({"BufEnter","InsertEnter","BufWinEnter","FileType","WinEnter"}, {
  callback = enforce_wrap_85,
})
vim.api.nvim_create_autocmd("User", {
  pattern = "VeryLazy",
  callback = enforce_wrap_85,
})

-- Enforce spell and completion UI post-load
local function enforce_completion_spell()
  vim.opt.spell = true
  vim.opt.spelllang = "en_us"
  -- Enforce completeopt globally and locally (some configs clear it)
  vim.o.completeopt = "menu,menuone,noselect"
  vim.opt_local.completeopt = "menu,menuone,noselect"
end

pcall(enforce_completion_spell)

vim.api.nvim_create_autocmd({"BufEnter","InsertEnter","BufWinEnter","FileType","WinEnter"}, {
  callback = enforce_completion_spell,
})
vim.api.nvim_create_autocmd("User", {
  pattern = "VeryLazy",
  callback = enforce_completion_spell,
})


