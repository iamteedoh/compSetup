## roles/brewPackages/tasks/main.yml

- name: Gather facts
  ansible.builtin.setup:

- name: Ensure 'code' CLI is available (skip if not installing VS Code extensions)
  ansible.builtin.command: which code
  register: code_cli
  failed_when: false
  changed_when: false

- name: Ensure /usr/local/share/zsh is owned by the current user
  become: true
  ansible.builtin.command: >
    chown -R {{ ansible_user_id }} /usr/local/share/zsh /usr/local/share/zsh/site-functions
  when: ansible_facts['os_family'] == 'Darwin'

- name: Ensure /usr/local/share/zsh is writable by the current user
  become: true
  ansible.builtin.command: >
    chmod u+w /usr/local/share/zsh /usr/local/share/zsh/site-functions
  when: ansible_facts['os_family'] == 'Darwin'

- name: Upgrade all Homebrew packages manually
  ansible.builtin.shell: |
    brew update || true
    brew upgrade
  register: brew_upgrade_output
  changed_when: "'Already up-to-date.' not in brew_upgrade_output.stdout"

- name: Install Homebrew packages via brew
  community.general.homebrew:
    name: "{{ item }}"
    state: present
  loop: "{{ brewPackages }}"
  when: brewPackages is defined

- name: Install Homebrew Cask packages
  community.general.homebrew:
    name: "{{ item }}"
    state: present
    cask: true
  loop: "{{ caskPackages }}"
  when: caskPackages is defined

- name: Install VS Code extensions
  ansible.builtin.shell: "code --install-extension {{ item }} --force"
  loop: "{{ vscodeExtensions }}"
  when:
    - vscodeExtensions is defined
    - install_vscode_extensions | bool
    - code_cli.rc == 0
