## roles/brewPackages/tasks/main.yml

- name: Manually update and upgrade Homebrew
  ansible.builtin.shell: |
    brew update || true
    brew upgrade
  register: brew_upgrade_output
  changed_when: "'Already up-to-date.' not in brew_upgrade_output.stdout"

- name: Install Homebrew formula packages
  community.general.homebrew:
    name: "{{ item }}"
    state: present
  loop: "{{ brewPackages }}"
  when: brewPackages is defined

- name: Install Homebrew Cask packages
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: present
    accept_external_apps: yes
  loop: "{{ caskPackages }}"
  when: caskPackages is defined

- name: Check if VS Code executable exists
  ansible.builtin.stat:
    path: "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code"
  register: vscode_executable

- name: Get list of installed VS Code extensions
  ansible.builtin.command:
    argv:
      - "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code"
      - --list-extensions
  register: installed_extensions
  changed_when: false
  failed_when: false
  when:
    - install_vscode_extensions | default(false)
    - vscode_executable.stat.exists

- name: Determine which VS Code extensions are missing
  ansible.builtin.set_fact:
    missing_extensions: "{{ vscodeExtensions | difference(installed_extensions.stdout_lines | default([])) }}"
  when:
    - install_vscode_extensions | default(false)
    - vscode_executable.stat.exists

- name: Report that all VS Code extensions are already installed
  ansible.builtin.debug:
    msg: "All specified VS Code extensions are already installed. Skipping installation."
  when:
    - install_vscode_extensions | default(false)
    - vscode_executable.stat.exists
    - missing_extensions is defined
    - missing_extensions | length == 0

- name: Install missing VS Code extensions
  ansible.builtin.command:
    argv:
      - "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code"
      - --install-extension
      - "{{ item }}"
  loop: "{{ missing_extensions | default([]) }}"
  loop_control:
    label: "{{ item }}"
  when:
    - install_vscode_extensions | default(false)
    - vscode_executable.stat.exists
