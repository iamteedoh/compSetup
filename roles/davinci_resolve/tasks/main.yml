---
# DaVinci Resolve - Multi-Platform Dependency Installation, Download & Install
#
# 1. Installs platform-appropriate dependencies
# 2. Downloads DaVinci Resolve via Blackmagic Design's public API
# 3. Runs the installer (Linux .run / macOS .dmg+pkg)
# Skips download+install if DaVinci Resolve is already installed.

- name: Display DaVinci Resolve configuration
  ansible.builtin.debug:
    msg: >-
      DaVinci Resolve edition: {{ davinci_edition | default('free') | upper }}.
      Platform: {{ ansible_facts['system'] }} / {{ ansible_facts['os_family'] | default('N/A') }}.

# --- macOS (no dependencies needed) ---
- name: DaVinci Resolve on macOS
  when: ansible_facts['system'] == 'Darwin'
  ansible.builtin.debug:
    msg: >-
      macOS requires no additional dependencies for DaVinci Resolve.

# --- Debian/Ubuntu/Pop!_OS (apt) ---
- name: Install DaVinci Resolve dependencies on Debian-based systems
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['os_family'] == 'Debian'
  block:
    - name: Check current foreign architectures
      become: true
      ansible.builtin.command: dpkg --print-foreign-architectures
      register: foreign_arch
      changed_when: false

    - name: Enable i386 architecture
      become: true
      ansible.builtin.command: dpkg --add-architecture i386
      when: "'i386' not in foreign_arch.stdout.split()"

    - name: Refresh apt cache after adding i386 architecture
      become: true
      ansible.builtin.apt:
        update_cache: true
      changed_when: false

    - name: Resolve DaVinci Resolve dependency packages
      ansible.builtin.shell: |
        set -euo pipefail
        for pkg in {{ candidate_list | map('quote') | join(' ') }}; do
          if apt-cache show "$pkg" >/dev/null 2>&1; then
            echo "$pkg"
            exit 0
          fi
        done
        exit 1
      args:
        executable: /bin/bash
      register: davinci_apt_resolution
      changed_when: false
      failed_when: false
      loop: "{{ davinci_apt_dependency_candidates }}"
      loop_control:
        loop_var: candidate_list
        label: "{{ candidate_list | join(' | ') }}"

    - name: Fail if any DaVinci dependency could not be resolved
      ansible.builtin.fail:
        msg: "Unable to resolve package candidate(s): {{ item.candidate_list | join(' | ') }}"
      loop: "{{ davinci_apt_resolution.results }}"
      loop_control:
        label: "{{ item.candidate_list | join(' | ') }}"
      when: item.rc != 0

    - name: Collect resolved apt package list
      set_fact:
        davinci_packages_final: >-
          {{ davinci_apt_resolution.results
             | selectattr('rc', 'equalto', 0)
             | map(attribute='stdout')
             | map('trim')
             | list }}

    - name: Install DaVinci Resolve apt dependencies
      become: true
      ansible.builtin.apt:
        name: "{{ davinci_packages_final }}"
        state: present
        update_cache: false

# --- Fedora/RHEL (dnf) ---
- name: Install DaVinci Resolve dependencies on Red Hat-based systems
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['os_family'] == 'RedHat'
  block:
    - name: Install DaVinci Resolve dnf dependencies
      become: true
      ansible.builtin.dnf:
        name: "{{ davinci_dnf_packages }}"
        state: present

    - name: Deploy DaVinci Resolve wrapper script for Fedora
      become: true
      ansible.builtin.template:
        src: davinci-resolve-wrapper.sh.j2
        dest: "{{ davinci_wrapper_dest }}"
        owner: root
        group: root
        mode: "0755"

    - name: Display Fedora wrapper script notice
      ansible.builtin.debug:
        msg: >-
          Wrapper script installed at {{ davinci_wrapper_dest }}.
          Use this to launch DaVinci Resolve (handles Python and Wayland compatibility).

# --- Automated Download & Install ---
- name: Derive DaVinci Resolve product identifiers
  set_fact:
    davinci_product_slug: "{{ 'davinci-resolve-studio' if davinci_edition | default('free') == 'studio' else 'davinci-resolve' }}"
    davinci_product_name: "{{ 'DaVinci Resolve Studio' if davinci_edition | default('free') == 'studio' else 'DaVinci Resolve' }}"
    davinci_api_platform: "{{ 'linux' if ansible_facts['system'] == 'Linux' else 'mac' }}"
    davinci_install_check_path: "{{ davinci_install_check_macos if ansible_facts['system'] == 'Darwin' else davinci_install_check_linux }}"

- name: Check if DaVinci Resolve is already installed
  ansible.builtin.stat:
    path: "{{ davinci_install_check_path }}"
  register: davinci_already_installed

- name: Display installation status
  ansible.builtin.debug:
    msg: >-
      DaVinci Resolve is
      {{ 'already installed — skipping download' if davinci_already_installed.stat.exists else 'not installed — will download and install' }}.

- name: Download and install DaVinci Resolve
  when: not davinci_already_installed.stat.exists
  block:
    - name: Create download directory
      ansible.builtin.file:
        path: "{{ davinci_download_dir }}"
        state: directory
        mode: "0755"

    - name: Query latest DaVinci Resolve version
      ansible.builtin.uri:
        url: "{{ davinci_api_version_url }}/{{ davinci_product_slug }}/{{ davinci_api_platform }}"
        return_content: true
      register: davinci_version_response

    - name: Extract download ID and version from API response
      set_fact:
        davinci_download_id: "{{ davinci_version_response.json[davinci_api_platform].downloadId }}"
        davinci_version_major: "{{ davinci_version_response.json[davinci_api_platform].major }}"
        davinci_version_minor: "{{ davinci_version_response.json[davinci_api_platform].minor }}"
        davinci_version_release: "{{ davinci_version_response.json[davinci_api_platform].releaseNum }}"

    - name: Display version being downloaded
      ansible.builtin.debug:
        msg: "Downloading {{ davinci_product_name }} {{ davinci_version_major }}.{{ davinci_version_minor }}.{{ davinci_version_release }}"

    - name: Request download URL from Blackmagic Design
      ansible.builtin.uri:
        url: "{{ davinci_api_register_url }}/{{ davinci_download_id }}"
        method: POST
        headers:
          Accept: "application/json, text/plain, */*"
          Origin: "https://www.blackmagicdesign.com"
          Content-Type: "application/json;charset=UTF-8"
          User-Agent: "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"
        body_format: json
        body:
          firstname: "Download"
          lastname: "Only"
          email: "download@example.com"
          phone: "000-000-0000"
          country: "us"
          state: "California"
          city: "Automation"
          product: "{{ davinci_product_name }}"
        return_content: true
        status_code: 200
      register: davinci_url_response

    - name: Download DaVinci Resolve archive
      ansible.builtin.get_url:
        url: "{{ davinci_url_response.content }}"
        dest: "{{ davinci_download_dir }}/davinci_resolve.zip"
        mode: "0644"
        timeout: 600

    - name: Extract DaVinci Resolve archive
      ansible.builtin.unarchive:
        src: "{{ davinci_download_dir }}/davinci_resolve.zip"
        dest: "{{ davinci_download_dir }}"
        remote_src: true

    # --- Linux Installation ---
    - name: Find DaVinci Resolve installer (Linux)
      when: ansible_facts['system'] == 'Linux'
      ansible.builtin.find:
        paths: "{{ davinci_download_dir }}"
        patterns: "DaVinci_Resolve*.run"
        recurse: true
      register: davinci_run_installer

    - name: Run DaVinci Resolve installer (Linux)
      when:
        - ansible_facts['system'] == 'Linux'
        - davinci_run_installer.files | default([]) | length > 0
      become: true
      ansible.builtin.shell: |
        set -euo pipefail
        INSTALLER="{{ davinci_run_installer.files[0].path }}"
        chmod +x "$INSTALLER"
        SKIP_PACKAGE_CHECK=1 "$INSTALLER" -i -y -a
      args:
        executable: /bin/bash

    # --- macOS Installation ---
    - name: Find DaVinci Resolve DMG (macOS)
      when: ansible_facts['system'] == 'Darwin'
      ansible.builtin.find:
        paths: "{{ davinci_download_dir }}"
        patterns: "DaVinci_Resolve*.dmg"
        recurse: true
      register: davinci_dmg_file

    - name: Install DaVinci Resolve from DMG (macOS)
      when:
        - ansible_facts['system'] == 'Darwin'
        - davinci_dmg_file.files | default([]) | length > 0
      become: true
      ansible.builtin.shell: |
        set -euo pipefail
        DMG="{{ davinci_dmg_file.files[0].path }}"
        MOUNT_POINT=$(hdiutil attach "$DMG" -nobrowse -quiet | tail -1 | awk '{print $3}')
        PKG=$(find "$MOUNT_POINT" -name "*.pkg" -maxdepth 1 | head -1)
        if [[ -n "$PKG" ]]; then
          installer -pkg "$PKG" -target /
        fi
        hdiutil detach "$MOUNT_POINT" -quiet || true
      args:
        executable: /bin/bash

    # --- Cleanup ---
    - name: Clean up download directory
      ansible.builtin.file:
        path: "{{ davinci_download_dir }}"
        state: absent

- name: Verify DaVinci Resolve installation
  ansible.builtin.stat:
    path: "{{ davinci_install_check_path }}"
  register: davinci_post_install_check

- name: Display installation result
  ansible.builtin.debug:
    msg: >-
      {{ davinci_product_name }} installation
      {{ 'succeeded' if davinci_post_install_check.stat.exists else 'may require manual steps' }}.
      {% if ansible_facts['system'] == 'Linux' and ansible_facts['os_family'] == 'RedHat' %}
      Launch using: {{ davinci_wrapper_dest }}
      {% endif %}
      {% if davinci_edition | default('free') == 'studio' %}
      STUDIO LICENSE: You will need your license key or USB dongle to activate.
      {% endif %}

# --- Fallback: Manual Download Instructions (only if automated install didn't succeed) ---
- name: Display DaVinci Resolve manual download instructions
  when: not (davinci_post_install_check.stat.exists | default(false))
  ansible.builtin.debug:
    msg: >-
      DaVinci Resolve {{ 'Studio' if davinci_edition | default('free') == 'studio' else '(Free)' }}
      can be downloaded manually from {{ davinci_download_url }}
      (click "Download Only" to skip registration).
      {% if ansible_facts['system'] == 'Darwin' %}
      Open the .dmg and drag DaVinci Resolve to Applications.
      {% elif ansible_facts['os_family'] | default('') == 'Debian' %}
      Run the .run installer: chmod +x ./DaVinci_Resolve_*.run && sudo SKIP_PACKAGE_CHECK=1 ./DaVinci_Resolve_*.run -i -y -a
      {% elif ansible_facts['os_family'] | default('') == 'RedHat' %}
      Extract the .zip, then run: chmod +x ./DaVinci_Resolve_*.run && sudo SKIP_PACKAGE_CHECK=1 ./DaVinci_Resolve_*.run -i -y -a
      Launch using: {{ davinci_wrapper_dest }}
      {% endif %}
