---
- name: Configure DaVinci Resolve dependencies on Pop!_OS
  when:
    - ansible_facts['system'] == 'Linux'
    - detected_distribution == 'pop_os'
  block:
    - name: Check current foreign architectures
      become: true
      ansible.builtin.command: dpkg --print-foreign-architectures
      register: foreign_arch
      changed_when: false

    - name: Enable i386 architecture
      become: true
      ansible.builtin.command: dpkg --add-architecture i386
      when: "'i386' not in foreign_arch.stdout.split()"

    - name: Refresh apt cache after adding i386 architecture
      become: true
      ansible.builtin.apt:
        update_cache: true
      changed_when: false

    - name: Define DaVinci Resolve dependency candidates
      set_fact:
        davinci_dependency_candidates:
          - ["libapr1"]
          - ["libaprutil1"]
          - ["libasound2t64", "libasound2"]
          - ["libglib2.0-0t64", "libglib2.0-0"]
          - ["libglu1-mesa"]
          - ["libxcb-composite0"]
          - ["libxcb-cursor0"]
          - ["libxcb-damage0"]
          - ["libapr1:i386"]
          - ["libaprutil1:i386"]
          - ["libasound2t64:i386", "libasound2:i386"]
          - ["libglib2.0-0t64:i386", "libglib2.0-0:i386"]

    - name: Resolve DaVinci Resolve dependency packages
      ansible.builtin.shell: |
        set -euo pipefail
        for pkg in {{ candidate_list | map('quote') | join(' ') }}; do
          if apt-cache show "$pkg" >/dev/null 2>&1; then
            echo "$pkg"
            exit 0
          fi
        done
        exit 1
      args:
        executable: /bin/bash
      register: davinci_dependency_resolution
      changed_when: false
      failed_when: false
      loop: "{{ davinci_dependency_candidates }}"
      loop_control:
        loop_var: candidate_list
        label: "{{ candidate_list | join(' | ') }}"

    - name: Fail if any DaVinci dependency could not be resolved
      ansible.builtin.fail:
        msg: "Unable to resolve package candidate(s): {{ item.candidate_list | join(' | ') }}"
      loop: "{{ davinci_dependency_resolution.results }}"
      loop_control:
        label: "{{ item.candidate_list | join(' | ') }}"
      when: item.rc != 0

    - name: Collect DaVinci Resolve package list
      set_fact:
        davinci_packages_final: "{{ davinci_dependency_resolution.results | selectattr('rc', 'equalto', 0) | map(attribute='stdout') | map('trim') | list }}"

    - name: Install DaVinci Resolve Pop!_OS dependencies
      become: true
      ansible.builtin.apt:
        name: "{{ davinci_packages_final }}"
        state: present
        update_cache: false

