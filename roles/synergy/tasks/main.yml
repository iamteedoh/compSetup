---
- name: Check if Synergy is already installed
  ansible.builtin.shell: |
    set -euo pipefail
    if [ "{{ ansible_facts['system'] }}" = "Darwin" ]; then
      test -d /Applications/Synergy.app
    elif command -v rpm &>/dev/null; then
      rpm -q synergy &>/dev/null
    elif command -v dpkg &>/dev/null; then
      dpkg -s synergy &>/dev/null 2>&1
    else
      exit 1
    fi
  args:
    executable: /bin/bash
  register: synergy_check
  changed_when: false
  failed_when: false

- name: Install Synergy on macOS
  when:
    - ansible_facts['system'] == 'Darwin'
    - synergy_check.rc != 0
  block:
    - name: Determine macOS architecture for Synergy download
      ansible.builtin.set_fact:
        synergy_macos_arch: >-
          {%- if ansible_facts['architecture'] == 'arm64' -%}
            arm64
          {%- else -%}
            x64
          {%- endif -%}

    - name: Set Synergy macOS filename and URL variables
      ansible.builtin.set_fact:
        synergy_macos_filename: "synergy-{{ synergy_version }}-macos-{{ synergy_macos_arch }}.dmg"
        synergy_macos_landing_url: "https://symless.com/synergy/download/package/synergy-personal-v3/macos/synergy-{{ synergy_version }}-macos-{{ synergy_macos_arch }}.dmg"
        synergy_macos_download_dest: "/tmp/synergy-{{ synergy_version }}.dmg"

    - name: Display Synergy macOS download details
      ansible.builtin.debug:
        msg: "Fetching download token from: {{ synergy_macos_landing_url }}"

    - name: Fetch Synergy download token from landing page (macOS)
      ansible.builtin.shell: |
        set -euo pipefail
        curl -sL "{{ synergy_macos_landing_url }}" | sed -n 's/.*token["\]*:["\]*\([^"\\]*\).*/\1/p' | head -1
      args:
        executable: /bin/bash
      register: synergy_macos_token_result
      changed_when: false

    - name: Fail if macOS download token could not be extracted
      ansible.builtin.fail:
        msg: >-
          Could not extract Synergy download token from the landing page.
          The download page structure may have changed, or the version
          {{ synergy_version }} may not be available for macOS {{ synergy_macos_arch }}.
      when: synergy_macos_token_result.stdout | trim | length == 0

    - name: Download Synergy DMG via API
      ansible.builtin.get_url:
        url: "https://symless.com/synergy/api/download/{{ synergy_macos_filename }}?token={{ synergy_macos_token_result.stdout | trim }}"
        dest: "{{ synergy_macos_download_dest }}"
        mode: "0644"

    - name: Mount Synergy DMG
      ansible.builtin.command: hdiutil attach "{{ synergy_macos_download_dest }}" -nobrowse -noverify
      register: synergy_mount_result
      changed_when: true

    - name: Find Synergy mount point
      ansible.builtin.shell: |
        set -euo pipefail
        echo "{{ synergy_mount_result.stdout }}" | tail -1 | awk -F'\t' '{print $NF}'
      args:
        executable: /bin/bash
      register: synergy_mount_point
      changed_when: false

    - name: Copy Synergy.app to Applications
      ansible.builtin.shell: |
        set -euo pipefail
        cp -R "{{ synergy_mount_point.stdout | trim }}/Synergy.app" /Applications/
      args:
        executable: /bin/bash
      changed_when: true

    - name: Unmount Synergy DMG
      ansible.builtin.command: hdiutil detach "{{ synergy_mount_point.stdout | trim }}"
      changed_when: true

    - name: Clean up downloaded Synergy DMG
      ansible.builtin.file:
        path: "{{ synergy_macos_download_dest }}"
        state: absent

- name: Install Synergy on Linux
  when:
    - ansible_facts['system'] == 'Linux'
    - synergy_check.rc != 0
  block:
    - name: Determine Synergy download parameters
      ansible.builtin.set_fact:
        synergy_os_slug: >-
          {%- if ansible_facts['distribution'] == 'Fedora' -%}
            fedora-{{ ansible_facts['distribution_version'] }}
          {%- elif ansible_facts['distribution'] in ['Ubuntu', 'Pop!_OS'] -%}
            ubuntu-{{ ansible_facts['distribution_version'] }}
          {%- elif ansible_facts['distribution'] == 'Debian' -%}
            debian-{{ ansible_facts['distribution_major_version'] }}
          {%- else -%}
            unsupported
          {%- endif -%}
        synergy_pkg_ext: >-
          {%- if ansible_facts['os_family'] == 'RedHat' -%}
            rpm
          {%- elif ansible_facts['os_family'] == 'Debian' -%}
            deb
          {%- else -%}
            unsupported
          {%- endif -%}
        synergy_codename: >-
          {%- if ansible_facts['distribution'] in ['Ubuntu', 'Pop!_OS'] and ansible_facts['distribution_version'] is version('24.04', '<') -%}
            jammy
          {%- elif ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] is version('13', '<') -%}
            jammy
          {%- else -%}
            noble
          {%- endif -%}

    - name: Fail on unsupported distribution
      ansible.builtin.fail:
        msg: "Synergy installation is not supported on {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
      when: synergy_os_slug == 'unsupported' or synergy_pkg_ext == 'unsupported'

    - name: Set Synergy filename and URL variables
      ansible.builtin.set_fact:
        synergy_filename: "synergy-{{ synergy_version }}-linux-{{ synergy_codename }}-x86_64.{{ synergy_pkg_ext }}"
        synergy_landing_url: "https://symless.com/synergy/download/package/synergy-personal-v3/{{ synergy_os_slug }}/synergy-{{ synergy_version }}-linux-{{ synergy_codename }}-x86_64.{{ synergy_pkg_ext }}"
        synergy_download_dest: "/tmp/synergy-{{ synergy_version }}.{{ synergy_pkg_ext }}"

    - name: Display Synergy download details
      ansible.builtin.debug:
        msg: "Fetching download token from: {{ synergy_landing_url }}"

    - name: Fetch Synergy download token from landing page
      ansible.builtin.shell: |
        set -euo pipefail
        curl -sL "{{ synergy_landing_url }}" | grep -oP 'token\\":\\"\K[^\\]+'
      args:
        executable: /bin/bash
      register: synergy_token_result
      changed_when: false

    - name: Fail if download token could not be extracted
      ansible.builtin.fail:
        msg: >-
          Could not extract Synergy download token from the landing page.
          The download page structure may have changed, or the version
          {{ synergy_version }} may not be available for {{ synergy_os_slug }}.
      when: synergy_token_result.stdout | trim | length == 0

    - name: Download Synergy package via API
      ansible.builtin.get_url:
        url: "https://symless.com/synergy/api/download/{{ synergy_filename }}?token={{ synergy_token_result.stdout | trim }}"
        dest: "{{ synergy_download_dest }}"
        mode: "0644"
      register: synergy_download

    - name: Install Synergy RPM package
      become: true
      ansible.builtin.dnf:
        name: "{{ synergy_download_dest }}"
        state: present
        disable_gpg_check: true
      when: ansible_facts['os_family'] == 'RedHat'

    - name: Install Synergy DEB package
      become: true
      ansible.builtin.apt:
        deb: "{{ synergy_download_dest }}"
        state: present
      when: ansible_facts['os_family'] == 'Debian'

    - name: Clean up downloaded package
      ansible.builtin.file:
        path: "{{ synergy_download_dest }}"
        state: absent
